<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI éŠæˆ²ç”Ÿæˆæ©Ÿ v22.1 (è¼•é¬†æ„‰å¿«éŸ³æ¨‚ç‰ˆ)</title>
    <style>
        :root { --bg: #0f0c29; --panel: #302b63; --accent: #cb2d3e; --highlight: #ef473a; --text: #eee; --gold: #ffd700; --exp: #00e676; }
        
        body { font-family: 'å¾®è»Ÿæ­£é»‘é«”', sans-serif; background: linear-gradient(135deg, #24243e 0%, #302b63 100%); color: var(--text); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 10px; overflow-y: auto; }
        
        #console { width: 100%; max-width: 650px; background: rgba(0,0,0,0.6); border-radius: 20px; backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 0 50px rgba(0,0,0,0.8); display: flex; flex-direction: column; position: relative; z-index: 5; margin: 20px 0; max-height: 95vh; overflow-y: auto; }
        #console::-webkit-scrollbar { width: 8px; }
        #console::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }

        /* ç©å®¶æª”æ¡ˆå¡ */
        #profile-card { background: rgba(0,0,0,0.5); padding: 12px 20px; margin: 0; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
        .rank-badge { font-size: 2rem; margin-right: 15px; filter: drop-shadow(0 0 5px rgba(255,215,0,0.5)); }
        .profile-info { flex: 1; text-align: left; }
        .profile-name { font-size: 1rem; font-weight: bold; color: var(--highlight); }
        .coin-display { font-size: 0.9rem; color: var(--gold); font-weight: bold; }
        .exp-container { width: 100%; background: #444; height: 6px; border-radius: 4px; margin-top: 4px; overflow: hidden; }
        .exp-fill { height: 100%; background: var(--exp); width: 0%; transition: width 0.5s ease-out; }
        .level-text { font-size: 0.75rem; color: #aaa; margin-left: 8px; }

        /* è¨­å®šå€ */
        #setup-view { padding: 30px; text-align: center; width: 100%; box-sizing: border-box; }
        h1.title { margin: 0 0 5px 0; font-size: 1.6rem; background: -webkit-linear-gradient(#fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .subtitle { color: #888; font-size: 0.8rem; margin-bottom: 20px; }
        .music-note { color: #9cd1ff; font-size: 0.9rem; background: rgba(156,209,255,0.08); border: 1px dashed rgba(156,209,255,0.4); padding: 10px 12px; border-radius: 12px; margin-bottom: 18px; line-height: 1.4; }
        
        .input-group { margin-bottom: 15px; text-align: left; }
        input[type="password"], input[type="text"] { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #555; background: rgba(0,0,0,0.4); color: white; box-sizing: border-box; font-size: 1rem; text-align: center; letter-spacing: 1px;}
        
        .tabs { display: flex; justify-content: center; gap: 8px; margin-bottom: 20px; border-bottom: 1px solid #444; padding-bottom: 10px; }
        .tab-btn { background: transparent; border: 1px solid #444; padding: 8px 15px; border-radius: 50px; color: #aaa; cursor: pointer; transition: 0.3s; font-size: 0.9rem; }
        .tab-btn.active { background: var(--highlight); color: white; border-color: var(--highlight); }

        .mode-section { display: none; animation: fadeIn 0.4s; }
        .mode-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .file-upload { border: 2px dashed #444; padding: 30px; border-radius: 15px; cursor: pointer; position: relative; margin: 10px 0; background: rgba(255,255,255,0.02); transition: 0.3s; }
        .file-upload:hover { border-color: var(--highlight); background: rgba(233,69,96,0.05); }
        .file-upload input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        
        textarea { width: 100%; height: 100px; padding: 15px; border-radius: 10px; border: 1px solid #444; background: rgba(0,0,0,0.4); color: white; box-sizing: border-box; resize: vertical; font-size: 1rem; }

        .google-badge { display: inline-block; background: #4285F4; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; margin-bottom: 5px; }

        .btn-main { background: var(--highlight); color: white; border: none; padding: 15px 50px; font-size: 1.2rem; border-radius: 50px; cursor: pointer; width: 100%; font-weight: bold; transition: 0.3s; margin-top: 15px; box-shadow: 0 5px 20px rgba(233,69,96,0.3); }
        .btn-main:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(233,69,96,0.5); }
        .btn-main:disabled { background: #555; cursor: not-allowed; }

        #status-log { margin-top: 15px; font-size: 0.85rem; color: #bbb; text-align: left; background: rgba(0,0,0,0.8); padding: 12px; border-radius: 10px; display: none; min-height: 40px; max-height: 100px; overflow-y: auto; font-family: monospace; border: 1px solid #666; }
        .log-error { color: #ff6b6b; } .log-success { color: #69f0ae; } .log-google { color: #4285F4; font-weight: bold; }

        /* éŠæˆ²å€ */
        #game-view { display: none; flex-direction: column; min-height: 600px; width: 100%; position: relative; }
        .game-header { padding: 15px 20px; background: rgba(0,0,0,0.3); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.05); flex-shrink: 0; }
        .btn-nav { background: transparent; border: 1px solid #666; color: #ccc; padding: 6px 15px; border-radius: 20px; cursor: pointer; font-size: 0.85rem; }
        .btn-nav:hover { color: white; border-color: white; }
        .status-badge { background: #333; padding: 5px 15px; border-radius: 20px; font-size: 0.9rem; color: #aaa; font-weight: bold; }
        .info-bar { display: flex; justify-content: space-between; align-items: center; gap: 10px; padding: 10px 20px; background: rgba(0,0,0,0.25); border-bottom: 1px solid rgba(255,255,255,0.06); flex-wrap: wrap; }
        #streak-display { color: #ffb74d; font-weight: bold; letter-spacing: 1px; }
        .utility-buttons { display: flex; gap: 10px; align-items: center; }
        .btn-utility { border-color: #888; color: #eee; }
        .btn-utility:disabled { opacity: 0.4; cursor: not-allowed; }

        #scene-area { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; overflow-y: auto; }
        #scene-emoji { font-size: 4rem; margin-bottom: 15px; filter: drop-shadow(0 0 10px rgba(255,255,255,0.2)); }
        #scene-text { font-size: 1.3rem; line-height: 1.5; background: rgba(255,255,255,0.08); padding: 20px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.1); width: 90%; max-width: 500px; }
        
        #action-area { padding: 20px 20px 40px 20px; background: rgba(0,0,0,0.2); min-height: 150px; display: flex; flex-direction: column; justify-content: center; align-items: center; flex-shrink: 0; }
        
        .choices-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 600px; }
        .btn-choice { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 18px; border-radius: 12px; cursor: pointer; font-size: 1.1rem; transition: 0.2s; font-weight: bold; min-height: 60px; display: flex; align-items: center; justify-content: center; }
        .btn-choice:hover { background: rgba(255,255,255,0.15); border-color: var(--highlight); transform: translateY(-2px); }
        .btn-choice.disabled-option { opacity: 0.35; filter: grayscale(0.6); border-style: dashed; }
        .input-area { width: 100%; max-width: 400px; display: flex; gap: 10px; margin-bottom: 10px; }
        #answer-input { flex: 1; padding: 15px; font-size: 1.2rem; border-radius: 10px; border: 2px solid #555; background: rgba(0,0,0,0.5); color: white; text-align: center; }
        .btn-submit { background: var(--highlight); color: white; border: none; padding: 0 30px; border-radius: 10px; font-weight: bold; cursor: pointer; }

        .helper-msg { min-height: 24px; text-align: center; color: #9cd1ff; letter-spacing: 1px; padding: 6px 10px; margin: 0 20px 15px 20px; background: rgba(255,255,255,0.05); border-radius: 12px; border: 1px dashed rgba(156,209,255,0.4); transition: opacity 0.3s ease; }
        .helper-msg:empty { opacity: 0; border-color: transparent; }

        #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; z-index: 20; padding: 20px; box-sizing: border-box; }
        #overlay h2 { font-size: 3rem; margin: 0 0 10px 0; }
        #overlay p { font-size: 1.2rem; margin: 0 0 20px 0; max-width: 80%; line-height: 1.5; color: #ddd; }
        
        .reward-box { background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; border: 1px solid gold; margin-bottom: 20px; width: 80%; max-width: 400px; }
        .reward-item { font-size: 1.1rem; margin: 5px 0; color: #fff; }
        .reward-highlight { color: var(--gold); font-weight: bold; font-size: 1.3rem; }
    </style>
</head>
<body>

<div id="console">
    <div id="profile-card">
        <div class="rank-badge" id="rank-icon">ğŸ¥‰</div>
        <div class="profile-info">
            <div class="profile-name" id="rank-name">éŠ…ç‰Œå†’éšªå®¶</div>
            <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                <div class="coin-display">ğŸ’° <span id="coin-count">0</span></div>
                <div class="level-text">Lv.<span id="level-num">1</span></div>
            </div>
            <div class="exp-container">
                <div class="exp-fill" id="exp-bar"></div>
            </div>
        </div>
    </div>

    <div id="setup-view">
        <h1 class="title">AI éŠæˆ²ç”Ÿæˆæ©Ÿ v22.1</h1>
        <div class="subtitle">é¸é …æ’åºä¿®å¾© â€¢ Google è¯ç¶² â€¢ æ™ºèƒ½æœé¡Œ â€¢ å‘¨æ°å€«ã€Šæ™´å¤©ã€‹ä¸»é¡Œæ›²</div>
        <div class="music-note">ğŸµ ç¾åœ¨æ”¹ç‚ºæ’­æ”¾å‘¨æ°å€«ã€Šæ™´å¤©ã€‹ï¼Œåœ¨ç†Ÿæ‚‰çš„æ—‹å¾‹ä¸­å±•é–‹ä½ çš„å†’éšªï¼</div>
        
        <div class="input-group">
            <input type="password" id="api-key" placeholder="åœ¨æ­¤è²¼ä¸Š API Key (è‡ªå‹•å„²å­˜)">
        </div>
        
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('image')">ğŸ“¸ åœ–ç‰‡</button>
            <button class="tab-btn" onclick="switchTab('text')">ğŸ“ æ–‡å­—</button>
            <button class="tab-btn" onclick="switchTab('search')">ğŸ” æ™ºèƒ½æœé¡Œ</button>
        </div>

        <div id="mode-image" class="mode-section active">
            <div class="file-upload">
                <input type="file" id="image-input" accept="image/*" onchange="previewImage(this)">
                <div id="file-label">é»æ“Šä¸Šå‚³åœ–ç‰‡ ğŸ“·</div>
            </div>
            <img id="preview" style="max-width: 150px; display: none; margin: 0 auto 15px auto; border-radius: 10px; border: 2px solid #555;">
        </div>

        <div id="mode-text" class="mode-section">
            <textarea id="text-input" placeholder="è«‹è²¼ä¸Šæ–‡ç« ã€æ•…äº‹æˆ–è€ƒé¡Œå…§å®¹..."></textarea>
        </div>

        <div id="mode-search" class="mode-section">
            <span class="google-badge">Google Search Enabled</span>
            <input type="text" id="search-input" placeholder="è¼¸å…¥ä¸»é¡Œ (å¦‚: 2024å¥§é‹ã€Pythonæ•™å­¸...)" style="margin-top:10px; text-align:center;">
            <div style="font-size: 0.8rem; color: #888; margin-top: 10px;">
                ğŸ’¡ ç³»çµ±å°‡æœƒä½¿ç”¨ <b>Google æœå°‹</b> æŸ¥æ‰¾æœ€æ–°è³‡è¨Šä¾†å‡ºé¡Œã€‚
            </div>
        </div>

        <button class="btn-main" id="generate-btn" onclick="startProcess()">ğŸš€ é–‹å§‹æŒ‘æˆ°</button>
        <div id="status-log">æº–å‚™å°±ç·’...</div>
    </div>

    <div id="game-view">
        <div class="game-header">
            <div class="header-left">
                <button class="btn-nav" onclick="goHome()">ğŸ  æ”¾æ£„</button>
            </div>
            <div id="hp-display" style="letter-spacing: 2px;">â¤ï¸â¤ï¸â¤ï¸â¤ï¸â¤ï¸</div>
            <div class="status-badge" id="level-display">Q 1/10</div>
        </div>
        <div class="info-bar">
            <div id="streak-display">ğŸ”¥ é€£æ“Šï¼š0</div>
            <div class="utility-buttons">
                <button class="btn-nav btn-utility" id="hint-btn" onclick="useHint()">ğŸ’¡ æç¤º (-20)</button>
                <button class="btn-nav btn-utility" id="heal-btn" onclick="buyHeal()">ğŸ©¹ è£œè¡€ (-30)</button>
            </div>
        </div>
        <div id="scene-area">
            <div id="scene-emoji">ğŸ¤–</div>
            <div id="scene-text">è¼‰å…¥ä¸­...</div>
        </div>
        <div id="action-area"></div>
        <div id="helper-msg" class="helper-msg"></div>
    </div>

    <div id="overlay">
        <h2 id="ov-icon">ğŸ‰</h2>
        <div id="reward-panel"></div>
        <p id="ov-text">è¨Šæ¯</p>
        <button class="btn-main" style="width: auto;" onclick="closeOverlay()">ç¹¼çºŒ</button>
    </div>
</div>

<div id="music-player" style="position: fixed; width: 0; height: 0; overflow: hidden; pointer-events: none;"></div>

<script>
    const TARGET_MODEL = "gemini-2.5-flash";
    const XP_PER_LEVEL = 500;
    const MAX_HP = 5;
    const HINT_COST = 20;
    const HEAL_COST = 30;
    const STREAK_REWARD = 5;

    // ä¸»é¡Œæ›²ï¼šå‘¨æ°å€«ã€Šæ™´å¤©ã€‹
    const THEME_TRACK = {
        videoId: "StEJrZ9TQNw",
        label: "å‘¨æ°å€« - æ™´å¤©"
    };

    let ytPlayer = null;
    let musicRequested = false;

    function loadYouTubeAPI() {
        if (document.getElementById('youtube-api')) return;
        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        tag.id = 'youtube-api';
        document.head.appendChild(tag);
    }

    function playThemeTrack() {
        if (!ytPlayer || typeof ytPlayer.loadVideoById !== 'function') return;
        ytPlayer.loadVideoById({ videoId: THEME_TRACK.videoId, suggestedQuality: 'small' });
        ytPlayer.setLoop(true);
    }

    function startYouTubeMusic() {
        if (musicRequested) return;
        musicRequested = true;
        loadYouTubeAPI();
        if (ytPlayer && ytPlayer.playVideo) {
            playThemeTrack();
            ytPlayer.playVideo();
        }
    }

    window.onYouTubeIframeAPIReady = () => {
        ytPlayer = new YT.Player('music-player', {
            height: '0',
            width: '0',
            videoId: THEME_TRACK.videoId,
            playerVars: {
                autoplay: 0,
                controls: 0,
                disablekb: 1,
                rel: 0,
                modestbranding: 1
            },
            events: {
                onReady: (event) => {
                    event.target.setVolume(20);
                    if (musicRequested) {
                        playThemeTrack();
                        event.target.playVideo();
                    }
                },
                onStateChange: (event) => {
                    if (event.data === YT.PlayerState.ENDED) {
                        playThemeTrack();
                    }
                }
            }
        });
    };

    let player = { level: 1, xp: 0, coins: 0, totalGames: 0 };

    function loadProfile() {
        const saved = localStorage.getItem('ai_game_profile_v18'); 
        if (saved) player = JSON.parse(saved);
        updateProfileUI();
    }

    function saveProfile() {
        localStorage.setItem('ai_game_profile_v18', JSON.stringify(player));
        updateProfileUI();
    }

    function updateProfileUI() {
        while (player.xp >= XP_PER_LEVEL) {
            player.xp -= XP_PER_LEVEL;
            player.level++;
        }
        let rankName = "éŠ…ç‰Œå†’éšªå®¶", rankIcon = "ğŸ¥‰", rankColor = "#cd7f32";
        if (player.level >= 20) { rankName = "é‘½çŸ³å‚³èªª"; rankIcon = "ğŸ’"; rankColor = "#b9f2ff"; }
        else if (player.level >= 15) { rankName = "ç™½é‡‘å®—å¸«"; rankIcon = "ğŸ’ "; rankColor = "#e5e4e2"; }
        else if (player.level >= 10) { rankName = "é»ƒé‡‘å¤§å¸«"; rankIcon = "ğŸ¥‡"; rankColor = "#ffd700"; }
        else if (player.level >= 5) { rankName = "éŠ€ç‰Œå‹‡è€…"; rankIcon = "ğŸ¥ˆ"; rankColor = "#c0c0c0"; }

        document.getElementById('rank-icon').innerText = rankIcon;
        document.getElementById('rank-name').innerText = rankName;
        document.getElementById('rank-name').style.color = rankColor;
        document.getElementById('coin-count').innerText = player.coins;
        document.getElementById('level-num').innerText = player.level;
        document.getElementById('exp-bar').style.width = `${(player.xp / XP_PER_LEVEL) * 100}%`;
    }

    const keyInput = document.getElementById('api-key');
    if(localStorage.getItem('gemini_key')) keyInput.value = localStorage.getItem('gemini_key');

    let gameData = null;
    let currentStage = 0;
    let hp = MAX_HP;
    let streak = 0;
    let hintUsed = false;
    let pendingAction = null;
    let currentMode = 'image';

    document.addEventListener('DOMContentLoaded', startYouTubeMusic);
    ['click', 'touchstart', 'keydown'].forEach(evt => {
        document.addEventListener(evt, () => startYouTubeMusic());
    });

    loadProfile();
    updateStreakDisplay();
    updateUtilityButtons();

    function switchTab(mode) {
        currentMode = mode;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.mode-section').forEach(s => s.classList.remove('active'));
        if (mode === 'image') {
            document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
            document.getElementById('mode-image').classList.add('active');
        } else if (mode === 'text') {
            document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
            document.getElementById('mode-text').classList.add('active');
        } else {
            document.querySelector('.tab-btn:nth-child(3)').classList.add('active');
            document.getElementById('mode-search').classList.add('active');
        }
    }

    function goHome() {
        if (confirm("è¿”å›é¦–é å°‡å¤±å»ç•¶å‰é€²åº¦ï¼Œç¢ºå®šå—ï¼Ÿ")) {
            location.reload();
        }
    }

    function log(msg, type='info') {
        const logBox = document.getElementById('status-log');
        logBox.style.display = 'block';
        const line = document.createElement('div');
        line.className = `log-line log-${type}`;
        line.innerHTML = `> ${msg}`;
        logBox.appendChild(line);
        logBox.scrollTop = logBox.scrollHeight;
    }

    function updateHelperMsg(msg) {
        document.getElementById('helper-msg').innerText = msg;
    }

    function updateStreakDisplay() {
        document.getElementById('streak-display').innerText = `ğŸ”¥ é€£æ“Šï¼š${streak}`;
    }

    function updateUtilityButtons() {
        const hintBtn = document.getElementById('hint-btn');
        const healBtn = document.getElementById('heal-btn');
        hintBtn.disabled = hintUsed || player.coins < HINT_COST;
        healBtn.disabled = hp >= MAX_HP || player.coins < HEAL_COST;
    }

    function previewImage(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('preview').src = e.target.result;
                document.getElementById('preview').style.display = 'block';
                document.getElementById('file-label').innerText = "åœ–ç‰‡å·²å°±ç·’";
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    async function startProcess() {
        const apiKey = keyInput.value.trim();
        const logBox = document.getElementById('status-log');
        logBox.innerHTML = '';
        logBox.style.display = 'block';
        
        if (!apiKey) return log("è«‹è¼¸å…¥ API Key", "error");

        let inputData = null;
        let isImage = false;
        let isSearch = false;

        if (currentMode === 'image') {
            const file = document.getElementById('image-input').files[0];
            if (!file) return log("è«‹ä¸Šå‚³åœ–ç‰‡", "error");
            log("æ­£åœ¨è™•ç†åœ–ç‰‡...");
            const compressedBase64 = await compressImage(file);
            inputData = compressedBase64.split(',')[1];
            isImage = true;
        } else if (currentMode === 'text') {
            const textVal = document.getElementById('text-input').value.trim();
            if (!textVal) return log("è«‹è¼¸å…¥æ–‡å­—", "error");
            inputData = textVal;
            isImage = false;
        } else {
            const searchVal = document.getElementById('search-input').value.trim();
            if (!searchVal) return log("è«‹è¼¸å…¥é—œéµå­—", "error");
            inputData = searchVal;
            isImage = false;
            isSearch = true;
        }

        localStorage.setItem('gemini_key', apiKey);
        document.getElementById('generate-btn').disabled = true;

        try {
            if (isSearch) {
                log(`ğŸš€ æ­£åœ¨ Google æœå°‹: ${inputData}...`, "google");
                document.getElementById('generate-btn').innerText = "ğŸŒ è¯ç¶²æœå°‹ä¸­...";
            } else {
                log(`æ­£åœ¨é€£ç·š AI...`);
            }
            
            const result = await callGemini(apiKey, TARGET_MODEL, inputData, isImage, isSearch);
            log(`âœ… ç”Ÿæˆå®Œç•¢ï¼æº–å‚™é–‹å§‹...`, "success");
            
            gameData = result;
            setTimeout(startGame, 1000);

        } catch (e) {
            console.error(e);
            log("éŒ¯èª¤: " + e.message, "error");
            document.getElementById('generate-btn').innerText = "ğŸš€ é–‹å§‹æŒ‘æˆ°";
            document.getElementById('generate-btn').disabled = false;
        }
    }

    function compressImage(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const MAX = 800;
                    let w = img.width, h = img.height;
                    if (w > MAX) { h *= MAX/w; w = MAX; }
                    canvas.width = w; canvas.height = h;
                    ctx.drawImage(img, 0, 0, w, h);
                    resolve(canvas.toDataURL('image/jpeg', 0.7));
                };
            };
        });
    }

    async function callGemini(key, model, data, isImage, isSearch) {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`;
        
        let userPart;
        let systemPrompt;
        let toolsPayload = [];

        if (isImage) {
            userPart = { inline_data: { mime_type: "image/jpeg", data: data } };
            systemPrompt = "Analyze the image content.";
        } else if (isSearch) {
            userPart = { text: `Research Topic: ${data}` };
            toolsPayload = [{ google_search: {} }];
            systemPrompt = `
                You are an Expert Teacher with access to Google Search.
                User wants a quiz on: "${data}".
                ACTION: Use Google Search to find accurate facts.
            `;
        } else {
            userPart = { text: `Material: ${data}` };
            systemPrompt = "Analyze the text material.";
        }

        const fullPrompt = `
            ${systemPrompt}
            TASK: Generate exactly 10 quiz stages.
            AUDIENCE: Adapt difficulty based on the topic.
            LANGUAGE: Traditional Chinese (ç¹é«”ä¸­æ–‡).
            TYPES: Mix 'choice' and 'fill'.
            FEEDBACK: Detailed explanations are required.
            
            JSON Format:
            {
                "stages": [
                    {
                        "type": "choice", "emoji": "ğŸ”¢", "text": "Question",
                        "options": [{ "text": "A. Answer1", "correct": false, "feedback": "..." }, { "text": "B. Answer2", "correct": true, "feedback": "..." }],
                        "answer": "answer_if_fill", "feedback_correct": "...", "feedback_wrong": "..."
                    }
                ]
            }
            Return ONLY JSON.
        `;

        const requestBody = {
            contents: [{ parts: [{ text: fullPrompt }, userPart] }]
        };

        if (isSearch) {
            requestBody.tools = toolsPayload;
        }

        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody)
        });

        if (!response.ok) throw new Error(`API Error ${response.status}`);
        const resData = await response.json();
        
        const candidates = resData.candidates;
        if (!candidates || candidates.length === 0) throw new Error("No response from AI");
        
        const rawText = candidates[0].content.parts.map(p => p.text).join(''); 
        const jsonString = rawText.substring(rawText.indexOf('{'), rawText.lastIndexOf('}') + 1);
        try { return JSON.parse(jsonString); } catch(e) { throw new Error("JSON Parse Error"); }
    }

    function startGame() {
        document.getElementById('setup-view').style.display = 'none';
        document.getElementById('game-view').style.display = 'flex';
        currentStage = 0; hp = MAX_HP; streak = 0; hintUsed = false;
        renderStage();
    }

    function renderStage() {
        if (currentStage >= gameData.stages.length) {
            handleGameClear();
            return;
        }
        const stage = gameData.stages[currentStage];
        document.getElementById('level-display').innerText = `Q ${currentStage+1}/10`;
        hintUsed = false;
        updateHP();
        updateStreakDisplay();
        updateUtilityButtons();
        updateHelperMsg('');
        document.getElementById('scene-emoji').innerText = stage.emoji;
        document.getElementById('scene-text').innerText = stage.text;
        
        const area = document.getElementById('action-area');
        area.innerHTML = '';

        if (stage.type === 'fill') {
            const wrapper = document.createElement('div');
            wrapper.className = 'input-area';
            const input = document.createElement('input');
            input.id = 'answer-input';
            input.placeholder = "è¼¸å…¥ç­”æ¡ˆ...";
            input.autocomplete = "off";
            const btn = document.createElement('button');
            btn.className = 'btn-submit';
            btn.innerText = "é€å‡º";
            btn.onclick = () => checkFillAns(stage, input.value);
            input.addEventListener("keypress", function(event) { if (event.key === "Enter") btn.click(); });
            wrapper.appendChild(input);
            wrapper.appendChild(btn);
            area.appendChild(wrapper);
            setTimeout(() => input.focus(), 100);
        } else {
            const grid = document.createElement('div');
            grid.className = 'choices-grid';
            // ä¿®æ­£ï¼šä¸å†éš¨æ©Ÿæ´—ç‰Œé¸é …ï¼Œä¿ç•™ AI ç”Ÿæˆçš„é †åº (A, B, C, D)
            let opts = stage.options; 
            opts.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'btn-choice';
                btn.innerText = opt.text;
                btn.onclick = () => checkChoiceAns(opt);
                grid.appendChild(btn);
            });
            area.appendChild(grid);
        }
    }

    function checkFillAns(stage, userVal) {
        if (!userVal.trim()) return;
        const cleanUser = userVal.trim().toLowerCase();
        const cleanAns = stage.answer.toString().toLowerCase();
        if (cleanUser === cleanAns) handleCorrect(stage.feedback_correct);
        else handleWrong(stage.feedback_wrong);
    }

    function checkChoiceAns(opt) {
        if (opt.correct) handleCorrect(opt.feedback);
        else handleWrong(opt.feedback);
    }

    function handleCorrect(feedback) {
        streak++;
        let bonusText = '';
        if (streak > 0 && streak % 3 === 0) {
            player.coins += STREAK_REWARD;
            saveProfile();
            bonusText = `\né€£çºŒ${streak}é¡Œæ­£ç¢ºï¼ç²å¾—é€£æ“Šçå‹µ ğŸ’° +${STREAK_REWARD}`;
        }
        updateStreakDisplay();
        updateUtilityButtons();
        showOverlay("â­•", feedback + bonusText, false, true);
    }

    function handleWrong(feedback) {
        streak = 0;
        hp--; updateHP();
        updateStreakDisplay();
        updateUtilityButtons();
        if(hp<=0) handleGameOver(feedback);
        else showOverlay("âŒ", feedback, false, false);
    }

    function updateHP() {
        let h = "";
        for(let i=0;i<hp;i++) h+="â¤ï¸";
        for(let i=hp;i<MAX_HP;i++) h+="ğŸ–¤";
        document.getElementById('hp-display').innerText = h;
    }

    function useHint() {
        const stage = gameData?.stages?.[currentStage];
        if (!stage) return;
        if (hintUsed) return updateHelperMsg('æœ¬é¡Œçš„æç¤ºå·²ç¶“ç”¨éå›‰ï¼');
        if (player.coins < HINT_COST) return updateHelperMsg('é‡‘å¹£ä¸è¶³ï¼Œå®Œç¾é€šé—œæˆ–é€£æ“Šå¯ä»¥è³ºå–ï¼');

        player.coins -= HINT_COST;
        hintUsed = true;
        saveProfile();

        if (stage.type === 'fill') {
            const prefix = stage.answer?.toString().slice(0, 2) || '';
            updateHelperMsg(`æç¤ºï¼šç­”æ¡ˆé–‹é ­ç‚ºã€Œ${prefix || 'ï¼Ÿ'}ã€`);
        } else {
            const buttons = Array.from(document.querySelectorAll('.btn-choice'));
            const wrongOpt = stage.options.find(o => !o.correct);
            const targetBtn = buttons.find(b => b.innerText === wrongOpt?.text);
            if (targetBtn) {
                targetBtn.disabled = true;
                targetBtn.classList.add('disabled-option');
            }
            updateHelperMsg('å·²æ’é™¤ä¸€å€‹å¹²æ“¾é¸é …ï¼Œå‰©é¤˜ç­”æ¡ˆæ›´æ¸…æ™°ï¼');
        }
        updateUtilityButtons();
    }

    function buyHeal() {
        if (hp >= MAX_HP) return updateHelperMsg('ç”Ÿå‘½å·²æ»¿ï¼Œä¸éœ€è¦è£œè¡€ã€‚');
        if (player.coins < HEAL_COST) return updateHelperMsg('é‡‘å¹£ä¸è¶³ï¼Œè©¦è‘—ä¿æŒé€£æ“Šä¾†ç´¯ç©ï¼');
        player.coins -= HEAL_COST;
        hp = Math.min(MAX_HP, hp + 1);
        saveProfile();
        updateHP();
        updateUtilityButtons();
        updateHelperMsg('è£œçµ¦å®Œæˆï¼ç”Ÿå‘½ +1');
    }

    function handleGameClear() {
        const baseXP = 100;
        const bonusCoins = hp * 10;
        const bonusXP = hp * 20;
        const totalXP = baseXP + bonusXP;

        player.coins += bonusCoins;
        player.xp += totalXP;
        player.totalGames++;
        streak = 0;
        saveProfile();
        updateStreakDisplay();
        updateUtilityButtons();

        const rewardHTML = `
            <div class="reward-box">
                <div class="reward-item">é€šé—œç¶“é©—: +${baseXP} XP</div>
                <div class="reward-item">ç”Ÿå‘½åŠ æˆ: +${bonusXP} XP</div>
                <div class="reward-item">è³ºå–é‡‘å¹£: <span class="reward-highlight">ğŸ’° +${bonusCoins}</span></div>
                <hr style="border:0; border-top:1px solid #555; margin:10px 0;">
                <div class="reward-item" style="color:#00e676;">ç¸½è¨ˆç²å¾—: ${totalXP} XP</div>
            </div>
        `;
        
        document.getElementById('reward-panel').innerHTML = rewardHTML;
        showOverlay("ğŸ†", "æ­å–œé€šé—œï¼çµç®—çå‹µå¦‚ä¸‹ï¼š", true, false);
    }

    function handleGameOver(reason) {
        const pityXP = 10;
        streak = 0;
        player.xp += pityXP;
        saveProfile();
        updateStreakDisplay();
        updateUtilityButtons();

        const rewardHTML = `
            <div class="reward-box" style="border-color: #ff5252;">
                <div class="reward-item">å®‰æ…°çå‹µ: +${pityXP} XP</div>
                <div class="reward-item" style="font-size:0.9rem; color:#aaa;">åˆ¥ç°å¿ƒï¼Œä¸‹æ¬¡ä¸€å®šè¡Œï¼</div>
            </div>
        `;
        document.getElementById('reward-panel').innerHTML = rewardHTML;
        showOverlay("ğŸ’€", "æŒ‘æˆ°å¤±æ•—...\n" + reason, false, false, true);
    }

    function showOverlay(icon, txt, isWin, isNext, isDead=false) {
        const ov = document.getElementById('overlay'); ov.style.display = 'flex';
        document.getElementById('ov-icon').innerText = icon;
        document.getElementById('ov-text').innerText = txt;
        const btn = document.querySelector('#overlay button');
        
        if (!isWin && !isDead) {
            document.getElementById('reward-panel').innerHTML = "";
        }

        if(isWin || isDead) {
            pendingAction = () => { location.reload(); };
            btn.innerText = "ğŸ  è¿”å›é¦–é  (å·²å­˜æª”)";
        } else if(isNext) {
            pendingAction = () => { ov.style.display='none'; currentStage++; renderStage(); };
            btn.innerText = "ä¸‹ä¸€é—œ";
        } else {
            pendingAction = () => { ov.style.display='none'; };
            btn.innerText = "å†è©¦ä¸€æ¬¡";
        }
    }
    function closeOverlay() { if(pendingAction) pendingAction(); }
</script>

</body>
</html>
