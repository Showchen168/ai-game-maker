<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI éŠæˆ²ç”Ÿæˆæ©Ÿ v16.0 (æ™ºèƒ½æœé¡Œç‰ˆ)</title>
    <style>
        :root { --bg: #0f0c29; --panel: #302b63; --accent: #cb2d3e; --highlight: #ef473a; --text: #eee; }
        body { font-family: 'å¾®è»Ÿæ­£é»‘é«”', sans-serif; background: linear-gradient(135deg, #24243e 0%, #302b63 100%); color: var(--text); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; overflow: hidden; }
        
        #console { width: 100%; max-width: 700px; background: rgba(0,0,0,0.6); border-radius: 20px; backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 0 50px rgba(0,0,0,0.8); overflow: hidden; display: flex; flex-direction: column; position: relative; transition: height 0.3s; z-index: 5; }

        /* å•Ÿå‹•é®ç½© */
        #start-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 999; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; transition: opacity 0.5s; }
        #start-overlay h1 { font-size: 3rem; color: white; margin-bottom: 20px; animation: pulse 1.5s infinite; }
        #start-overlay p { color: #ccc; font-size: 1.2rem; }
        @keyframes pulse { 0% { opacity: 0.8; transform: scale(1); } 50% { opacity: 1; transform: scale(1.05); } 100% { opacity: 0.8; transform: scale(1); } }

        /* è¨­å®šå€ */
        #setup-view { padding: 40px; text-align: center; width: 100%; box-sizing: border-box; }
        h1.title { margin: 0 0 10px 0; font-size: 2rem; background: -webkit-linear-gradient(#fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .subtitle { color: #888; font-size: 0.9rem; margin-bottom: 30px; }
        
        .input-group { margin-bottom: 20px; text-align: left; }
        label { font-size: 0.85rem; color: #aaa; display: block; margin-bottom: 8px; font-weight: bold; }
        input[type="password"], input[type="text"] { width: 100%; padding: 14px; border-radius: 10px; border: 1px solid #555; background: rgba(0,0,0,0.4); color: white; box-sizing: border-box; font-size: 1rem; }
        
        /* Tab åˆ‡æ› (3å€‹) */
        .tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 25px; border-bottom: 1px solid #444; padding-bottom: 15px; }
        .tab-btn { background: transparent; border: 1px solid #444; padding: 8px 15px; border-radius: 50px; color: #aaa; cursor: pointer; transition: 0.3s; font-size: 0.9rem; }
        .tab-btn.active { background: var(--highlight); color: white; border-color: var(--highlight); }

        .mode-section { display: none; }
        .mode-section.active { display: block; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .file-upload { border: 2px dashed #444; padding: 40px; border-radius: 15px; cursor: pointer; position: relative; margin: 10px 0; background: rgba(255,255,255,0.02); transition: 0.3s; }
        .file-upload:hover { border-color: var(--highlight); background: rgba(233,69,96,0.05); }
        .file-upload input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        
        textarea { width: 100%; height: 150px; padding: 15px; border-radius: 10px; border: 1px solid #444; background: rgba(0,0,0,0.4); color: white; box-sizing: border-box; resize: vertical; font-size: 1rem; }

        .btn-main { background: var(--highlight); color: white; border: none; padding: 16px 50px; font-size: 1.2rem; border-radius: 50px; cursor: pointer; width: 100%; font-weight: bold; transition: 0.3s; margin-top: 25px; box-shadow: 0 5px 20px rgba(233,69,96,0.3); }
        .btn-main:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(233,69,96,0.5); }
        .btn-main:disabled { background: #555; cursor: not-allowed; }

        #status-log { margin-top: 20px; font-size: 0.85rem; color: #bbb; text-align: left; background: rgba(0,0,0,0.8); padding: 15px; border-radius: 10px; display: none; height: 100px; overflow-y: auto; font-family: monospace; border: 1px solid #444; }
        .log-error { color: #ff6b6b; } .log-success { color: #69f0ae; }

        /* éŠæˆ²å€ */
        #game-view { display: none; flex-direction: column; height: 750px; width: 100%; position: relative; }
        
        .game-header { padding: 15px 20px; background: rgba(0,0,0,0.4); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .header-left { display: flex; gap: 10px; align-items: center; }
        .btn-nav { background: transparent; border: 1px solid #666; color: #ccc; padding: 6px 15px; border-radius: 20px; cursor: pointer; font-size: 0.85rem; display: flex; align-items: center; gap: 5px; }
        .btn-nav:hover { color: white; border-color: white; }
        
        .music-indicator { display: flex; gap: 3px; height: 15px; align-items: flex-end; margin-left: 10px; opacity: 0.5; }
        .music-indicator.active { opacity: 1; }
        .bar { width: 3px; background: var(--highlight); animation: none; }
        .music-indicator.active .bar { animation: bounce 1.5s infinite ease-in-out; }
        .bar:nth-child(1) { height: 60%; animation-delay: 0s; }
        .bar:nth-child(2) { height: 100%; animation-delay: 0.2s; }
        .bar:nth-child(3) { height: 50%; animation-delay: 0.4s; }
        @keyframes bounce { 0%, 100% { height: 30%; } 50% { height: 100%; } }

        #scene-area { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; overflow-y: auto; }
        #scene-emoji { font-size: 5rem; margin-bottom: 20px; filter: drop-shadow(0 0 20px rgba(255,255,255,0.2)); }
        #scene-text { font-size: 1.4rem; line-height: 1.6; background: rgba(255,255,255,0.08); padding: 30px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); width: 85%; max-width: 500px; }
        
        #action-area { padding: 30px; background: rgba(0,0,0,0.2); min-height: 180px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        
        .choices-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 600px; }
        .btn-choice { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 18px; border-radius: 12px; cursor: pointer; font-size: 1.1rem; transition: 0.2s; font-weight: bold; }
        .btn-choice:hover { background: rgba(255,255,255,0.15); border-color: var(--highlight); transform: translateY(-2px); }
        
        .input-area { width: 100%; max-width: 400px; display: flex; gap: 10px; }
        #answer-input { flex: 1; padding: 15px; font-size: 1.2rem; border-radius: 10px; border: 2px solid #555; background: rgba(0,0,0,0.5); color: white; text-align: center; }
        .btn-submit { background: var(--highlight); color: white; border: none; padding: 0 30px; border-radius: 10px; font-weight: bold; cursor: pointer; }

        #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; z-index: 20; padding: 20px; box-sizing: border-box; }
        #overlay h2 { font-size: 3.5rem; margin: 0 0 20px 0; }
        #overlay p { font-size: 1.3rem; margin: 0 0 35px 0; line-height: 1.6; max-width: 80%; background: rgba(255,255,255,0.1); padding: 25px; border-radius: 15px; }
    </style>
</head>
<body>

<div id="start-overlay" onclick="unlockAudioContext()">
    <h1>ğŸ‘† é»æ“Šç•«é¢é–‹å§‹</h1>
    <p>AI æ™ºèƒ½æœé¡Œ â€¢ å°ˆæ³¨éŸ³æ¨‚</p>
</div>

<div id="console">
    <div id="setup-view">
        <h1 class="title">AI éŠæˆ²ç”Ÿæˆæ©Ÿ v16.0</h1>
        <div class="subtitle">åœ–ç‰‡ â€¢ æ–‡å­— â€¢ æ™ºèƒ½æœé¡Œ (Smart Search)</div>
        
        <div class="input-group">
            <label>1. API Key (å¿…å¡«)</label>
            <input type="password" id="api-key" placeholder="è²¼ä¸Š API Key">
        </div>
        <div class="input-group">
            <label>2. æŒ‡å®šæ¨¡å‹ (é¸å¡«)</label>
            <input type="text" id="custom-model" placeholder="é è¨­è‡ªå‹•æ¸¬è©¦">
        </div>
        
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('image')">ğŸ“¸ åœ–ç‰‡</button>
            <button class="tab-btn" onclick="switchTab('text')">ğŸ“ æ–‡å­—</button>
            <button class="tab-btn" onclick="switchTab('search')">ğŸ” æ™ºèƒ½æœé¡Œ</button>
        </div>

        <div id="mode-image" class="mode-section active">
            <div class="file-upload">
                <input type="file" id="image-input" accept="image/*" onchange="previewImage(this)">
                <div id="file-label">é»æ“Šä¸Šå‚³åœ–ç‰‡ ğŸ“·</div>
            </div>
            <img id="preview" style="max-width: 150px; display: none; margin: 0 auto 15px auto; border-radius: 10px; border: 2px solid #555;">
        </div>

        <div id="mode-text" class="mode-section">
            <textarea id="text-input" placeholder="è«‹è²¼ä¸Šæ–‡ç« ã€æ•…äº‹æˆ–è€ƒé¡Œå…§å®¹..."></textarea>
        </div>

        <div id="mode-search" class="mode-section">
            <input type="text" id="search-input" placeholder="è¼¸å…¥é—œéµå­— (ä¾‹å¦‚: å°äº”æ•¸å­¸ã€å¤šç›Šè‹±æ–‡...)" style="margin-top:20px; text-align:center;">
            <div style="font-size: 0.8rem; color: #888; margin-top: 15px;">
                ğŸ’¡ AI å°‡æœƒé‹ç”¨é¾å¤§çš„è³‡æ–™åº«ï¼Œé‡å°æ‚¨è¼¸å…¥çš„ä¸»é¡Œè‡ªå‹•ç”Ÿæˆè€ƒé¡Œã€‚
            </div>
        </div>

        <button class="btn-main" id="generate-btn" onclick="startProcess()">ğŸš€ ç”Ÿæˆ 10 é—œæ¸¬é©—</button>
        <div id="status-log"></div>
    </div>

    <div id="game-view">
        <div class="game-header">
            <div class="header-left">
                <button class="btn-nav" onclick="goHome()">ğŸ  é¦–é </button>
                <button class="btn-nav" id="music-toggle" onclick="toggleMusic()">ğŸµ éŸ³æ¨‚</button>
                <div class="music-indicator" id="music-bars">
                    <div class="bar"></div><div class="bar"></div><div class="bar"></div>
                </div>
            </div>
            <div id="hp-display" style="letter-spacing: 3px;">â¤ï¸â¤ï¸â¤ï¸â¤ï¸â¤ï¸</div>
            <div class="status-badge" id="level-display">Q 1 / 10</div>
        </div>
        <div id="scene-area">
            <div id="scene-emoji">ğŸ¤–</div>
            <div id="scene-text">è¼‰å…¥ä¸­...</div>
        </div>
        <div id="action-area"></div>
    </div>

    <div id="overlay">
        <h2 id="ov-icon">ğŸ‰</h2>
        <p id="ov-text">è¨Šæ¯</p>
        <button class="btn-main" style="width: auto;" onclick="closeOverlay()">ç¹¼çºŒ</button>
    </div>
</div>

<audio id="bgm-player" loop></audio>

<script>
    const keyInput = document.getElementById('api-key');
    if(localStorage.getItem('gemini_key')) keyInput.value = localStorage.getItem('gemini_key');
    const modelInput = document.getElementById('custom-model');
    if(localStorage.getItem('gemini_model')) modelInput.value = localStorage.getItem('gemini_model');

    let gameData = null;
    let currentStage = 0;
    let hp = 5;
    let pendingAction = null;
    let currentMode = 'image';
    const FALLBACK_MODELS = ["gemini-2.0-flash-exp", "gemini-1.5-flash", "gemini-1.5-pro"];

    // éŸ³æ¨‚ç³»çµ±
    const BGM_PLAYLIST = [
        "https://upload.wikimedia.org/wikipedia/commons/3/35/Gymnopedie_No_1.mp3",
        "https://upload.wikimedia.org/wikipedia/commons/2/23/Debussy_-_Clair_de_lune_-_Dave_Horn.mp3",
        "https://upload.wikimedia.org/wikipedia/commons/8/86/Mozart_-_Sonata_No._16_in_C_Major_K545_-_I._Allegro.mp3"
    ];

    const audioPlayer = document.getElementById('bgm-player');
    const musicIndicator = document.getElementById('music-bars');
    const musicToggleBtn = document.getElementById('music-toggle');
    let isMusicPlaying = false;

    function unlockAudioContext() {
        const overlay = document.getElementById('start-overlay');
        overlay.style.opacity = '0';
        setTimeout(() => overlay.style.display = 'none', 500);
        const randomIndex = Math.floor(Math.random() * BGM_PLAYLIST.length);
        audioPlayer.src = BGM_PLAYLIST[randomIndex];
        audioPlayer.volume = 0.2;
        audioPlayer.play().then(() => {
            console.log("Audio unlocked!");
            audioPlayer.pause();
        }).catch(e => console.error("Unlock failed:", e));
    }

    function startMusic() {
        audioPlayer.currentTime = 0;
        audioPlayer.play().then(() => {
            isMusicPlaying = true;
            musicIndicator.classList.add('active');
            musicToggleBtn.innerHTML = "ğŸµ éŸ³æ¨‚é–‹";
            log("ğŸµ å°ˆæ³¨éŸ³æ¨‚å·²å•Ÿå‹•", "success");
        }).catch(e => {
            log("âš ï¸ éŸ³æ¨‚æ’­æ”¾å¤±æ•—", "error");
        });
    }

    function toggleMusic() {
        if (isMusicPlaying) {
            audioPlayer.pause();
            isMusicPlaying = false;
            musicIndicator.classList.remove('active');
            musicToggleBtn.innerHTML = "ğŸ”‡ éŸ³æ¨‚é—œ";
        } else {
            audioPlayer.play();
            isMusicPlaying = true;
            musicIndicator.classList.add('active');
            musicToggleBtn.innerHTML = "ğŸµ éŸ³æ¨‚é–‹";
        }
    }

    function stopMusic() {
        audioPlayer.pause();
        isMusicPlaying = false;
        musicIndicator.classList.remove('active');
    }

    function switchTab(mode) {
        currentMode = mode;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.mode-section').forEach(s => s.classList.remove('active'));
        if (mode === 'image') {
            document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
            document.getElementById('mode-image').classList.add('active');
        } else if (mode === 'text') {
            document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
            document.getElementById('mode-text').classList.add('active');
        } else {
            document.querySelector('.tab-btn:nth-child(3)').classList.add('active');
            document.getElementById('mode-search').classList.add('active');
        }
    }

    function goHome() {
        if (confirm("ç¢ºå®šè¦çµæŸéŠæˆ²è¿”å›é¦–é å—ï¼Ÿ")) {
            stopMusic();
            location.reload();
        }
    }

    function log(msg, type='info') {
        const logBox = document.getElementById('status-log');
        logBox.style.display = 'block';
        const line = document.createElement('div');
        line.className = `log-line log-${type}`;
        line.innerHTML = `> ${msg}`;
        logBox.appendChild(line);
        logBox.scrollTop = logBox.scrollHeight;
    }

    function previewImage(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('preview').src = e.target.result;
                document.getElementById('preview').style.display = 'block';
                document.getElementById('file-label').innerText = "åœ–ç‰‡å·²å°±ç·’";
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    async function startProcess() {
        const apiKey = keyInput.value.trim();
        let customModel = document.getElementById('custom-model').value.trim();
        document.getElementById('status-log').innerHTML = '';
        
        if (!apiKey) return log("è«‹è¼¸å…¥ API Key", "error");

        startMusic();

        let inputData = null;
        let isImage = false;
        let isSearch = false;

        if (currentMode === 'image') {
            const file = document.getElementById('image-input').files[0];
            if (!file) return log("è«‹ä¸Šå‚³åœ–ç‰‡", "error");
            log("æ­£åœ¨è™•ç†åœ–ç‰‡...");
            const compressedBase64 = await compressImage(file);
            inputData = compressedBase64.split(',')[1];
            isImage = true;
        } else if (currentMode === 'text') {
            const textVal = document.getElementById('text-input').value.trim();
            if (!textVal) return log("è«‹è¼¸å…¥æ–‡å­—", "error");
            inputData = textVal;
            isImage = false;
        } else {
            // Search Mode
            const searchVal = document.getElementById('search-input').value.trim();
            if (!searchVal) return log("è«‹è¼¸å…¥æœå°‹é—œéµå­—", "error");
            inputData = searchVal;
            isImage = false;
            isSearch = true;
        }

        localStorage.setItem('gemini_key', apiKey);
        localStorage.setItem('gemini_model', customModel);
        document.getElementById('generate-btn').disabled = true;

        try {
            let modelsToTry = [];
            if (customModel) {
                if (customModel.startsWith('models/')) customModel = customModel.replace('models/', '');
                modelsToTry = [customModel];
                log(`æŒ‡å®šä½¿ç”¨: ${customModel}`);
            } else {
                modelsToTry = FALLBACK_MODELS;
                log("è‡ªå‹•é¸æ“‡æœ€ä½³æ¨¡å‹...");
            }

            let successResult = null;
            for (const modelName of modelsToTry) {
                try {
                    log(`é€£æ¥ ${modelName}...`);
                    const result = await callGemini(apiKey, modelName, inputData, isImage, isSearch);
                    log(`âœ… æˆåŠŸï¼ç”Ÿæˆæ¸¬é©—æ•¸æ“š...`, "success");
                    successResult = result;
                    break; 
                } catch (err) {
                    if (err.message.includes("404")) log(`âŒ ${modelName} æœªå›æ‡‰`, "error");
                    else log(`âš ï¸ ${err.message}`, "error");
                }
            }

            if (!successResult) throw new Error("æ‰€æœ‰æ¨¡å‹é€£æ¥å¤±æ•—");

            gameData = successResult;
            setTimeout(startGame, 1000);

        } catch (e) {
            console.error(e);
            log("çµ‚æ­¢: " + e.message, "error");
            document.getElementById('generate-btn').disabled = false;
        }
    }

    function compressImage(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const MAX = 800;
                    let w = img.width, h = img.height;
                    if (w > MAX) { h *= MAX/w; w = MAX; }
                    canvas.width = w; canvas.height = h;
                    ctx.drawImage(img, 0, 0, w, h);
                    resolve(canvas.toDataURL('image/jpeg', 0.7));
                };
            };
        });
    }

    // --- æ ¸å¿ƒ AI é‚è¼¯ (å«æ™ºèƒ½æœå°‹ Prompt) ---
    async function callGemini(key, model, data, isImage, isSearch) {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`;
        
        let userPart;
        let systemPrompt;

        if (isImage) {
            userPart = { inline_data: { mime_type: "image/jpeg", data: data } };
            systemPrompt = "Analyze the image and generate a quiz.";
        } else if (isSearch) {
            // æ™ºèƒ½æœå°‹å°ˆç”¨ Prompt
            userPart = { text: `Topic: ${data}` };
            systemPrompt = `
                You are an expert teacher and curriculum designer. 
                The user wants to practice the topic: "${data}".
                Using your internal knowledge base, simulate a web search and generate relevant, high-quality quiz questions for this specific topic and difficulty level.
                If the topic is "TOEIC", use business English. If "Grade 5 Math", use appropriate math problems.
            `;
        } else {
            userPart = { text: `Material: ${data}` };
            systemPrompt = "Analyze the text material and generate a quiz.";
        }

        const fullPrompt = `
            ${systemPrompt}
            Target Audience: 10-year-old child in Taiwan (Traditional Chinese).
            Task: Generate exactly 10 stages (questions).
            Question Types: Mix of 'choice' (Multiple Choice) and 'fill' (Fill-in-the-blank).
            Randomness: Ensure questions cover different aspects of the topic.
            
            JSON Format:
            {
                "stages": [
                    {
                        "type": "choice", "emoji": "ğŸ”¢", "text": "Question",
                        "options": [{ "text": "A", "correct": false, "feedback": "Why" }, { "text": "B", "correct": true, "feedback": "Why" }],
                        "answer": "correct_answer_string", "feedback_correct": "Good", "feedback_wrong": "Bad"
                    }
                ]
            }
            Return ONLY JSON.
        `;

        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: fullPrompt }, userPart] }] })
        });

        if (!response.ok) throw new Error(response.status);
        const resData = await response.json();
        const rawText = resData.candidates[0].content.parts[0].text;
        const jsonString = rawText.substring(rawText.indexOf('{'), rawText.lastIndexOf('}') + 1);
        try { return JSON.parse(jsonString); } catch(e) { throw new Error("JSON Parse Error"); }
    }

    function startGame() {
        document.getElementById('setup-view').style.display = 'none';
        document.getElementById('game-view').style.display = 'flex';
        currentStage = 0; hp = 5; 
        renderStage();
    }

    function renderStage() {
        if (currentStage >= gameData.stages.length) {
            showOverlay("ğŸ†", "æ­å–œé€šé—œï¼\nå…¨èƒ½å°åšå£«å°±æ˜¯ä½ ï¼", true); return;
        }
        const stage = gameData.stages[currentStage];
        document.getElementById('level-display').innerText = `Q ${currentStage+1} / 10`;
        updateHP();
        document.getElementById('scene-emoji').innerText = stage.emoji;
        document.getElementById('scene-text').innerText = stage.text;
        
        const area = document.getElementById('action-area');
        area.innerHTML = '';

        if (stage.type === 'fill') {
            const wrapper = document.createElement('div');
            wrapper.className = 'input-area';
            const input = document.createElement('input');
            input.id = 'answer-input';
            input.placeholder = "è¼¸å…¥ç­”æ¡ˆ...";
            input.autocomplete = "off";
            const btn = document.createElement('button');
            btn.className = 'btn-submit';
            btn.innerText = "é€å‡º";
            btn.onclick = () => checkFillAns(stage, input.value);
            input.addEventListener("keypress", function(event) { if (event.key === "Enter") btn.click(); });
            wrapper.appendChild(input);
            wrapper.appendChild(btn);
            area.appendChild(wrapper);
            setTimeout(() => input.focus(), 100);
        } else {
            const grid = document.createElement('div');
            grid.className = 'choices-grid';
            let opts = [...stage.options].sort(() => Math.random() - 0.5);
            opts.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'btn-choice';
                btn.innerText = opt.text;
                btn.onclick = () => checkChoiceAns(opt);
                grid.appendChild(btn);
            });
            area.appendChild(grid);
        }
    }

    function checkFillAns(stage, userVal) {
        if (!userVal.trim()) return;
        const cleanUser = userVal.trim().toLowerCase();
        const cleanAns = stage.answer.toString().toLowerCase();
        if (cleanUser === cleanAns) {
            showOverlay("â­•", stage.feedback_correct, false, true);
        } else {
            hp--; updateHP();
            if(hp<=0) showOverlay("ğŸ’€", "éŠæˆ²çµæŸ...\n" + stage.feedback_wrong, false, false, true);
            else showOverlay("âŒ", stage.feedback_wrong, false, false);
        }
    }

    function checkChoiceAns(opt) {
        if (opt.correct) {
            showOverlay("â­•", opt.feedback, false, true);
        } else {
            hp--; updateHP();
            if(hp<=0) showOverlay("ğŸ’€", "éŠæˆ²çµæŸ...\n" + opt.feedback, false, false, true);
            else showOverlay("âŒ", opt.feedback, false, false);
        }
    }

    function updateHP() {
        let h = ""; 
        for(let i=0;i<hp;i++) h+="â¤ï¸"; 
        for(let i=hp;i<5;i++) h+="ğŸ–¤"; 
        document.getElementById('hp-display').innerText = h;
    }

    function showOverlay(icon, txt, isWin, isNext, isDead) {
        const ov = document.getElementById('overlay'); ov.style.display = 'flex';
        document.getElementById('ov-icon').innerText = icon;
        document.getElementById('ov-text').innerText = txt;
        const btn = document.querySelector('#overlay button');
        
        if(isWin || isDead) {
            pendingAction = () => { stopMusic(); location.reload(); };
            btn.innerText = "ğŸ  è¿”å›é¦–é è£½ä½œæ–°éŠæˆ²";
        } else if(isNext) {
            pendingAction = () => { ov.style.display='none'; currentStage++; renderStage(); };
            btn.innerText = "ä¸‹ä¸€é—œ";
        } else {
            pendingAction = () => { ov.style.display='none'; };
            btn.innerText = "å†è©¦ä¸€æ¬¡";
        }
    }
    function closeOverlay() { if(pendingAction) pendingAction(); }
</script>

</body>
</html>
